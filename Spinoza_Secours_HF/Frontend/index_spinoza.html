<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spinoza - Bergson and Friends</title>
<link rel="stylesheet" href="https://fjdaz.com/bergson/statics/style.css">
<link rel="stylesheet" href="https://fjdaz.com/bergson/statics/responsive.css" media="screen and (max-width: 768px)">
</head>
<body>
<div class="desktop-version">
<header>
  <img src="https://fjdaz.com/bergson/statics/img/BergsonAndFriendsLOGO.png">
</header>
<main>
  <section class="philosophers">

    <!-- Spinoza uniquement -->
    <article class="philosopher" id="spinoza">
      <button class="philosopher-trigger">
        <h2>Baruch <span>Spinoza</span></h2>
        <img src="https://fjdaz.com/bergson/statics/img/Spinoza.png" alt="Baruch Spinoza">
      </button>
      <div class="dialogue" hidden>
        <!-- üéÆ Ma√Øeuthon - Affichage score, consigne et compteur -->
        <div id="maieuthon-score-desktop" style="background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <div style="font-family: 'Serifa Std', serif; font-size: 1.7em; font-weight: bold; padding-left: 2em;">Ma√Øathon</div>
            <div style="font-family: 'Serifa Std', serif; font-size: 1.1em; color: white; padding-left: 2em;">R√©fl√©chis. Reformule. Questionne.</div>
            <div id="instruction-text-desktop" style="font-family: 'Serifa Std', serif; font-size: 1.1em; color: white;"></div>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; font-family: monospace;">
            <span id="maieuthon-exchange-count">√âchanges: 0/5</span>
            <span id="maieuthon-score-value" style="font-size: 18px; font-weight: bold; color: #4CAF50;">Score: 50</span>
          </div>
        </div>
        <div class="qa-history"></div>
        <div id="thinking-indicator-desktop" style="display: none; padding: 10px; font-style: italic; color: #666; text-align: left;">
          <span class="thinking-dots"></span>
        </div>
        <form class="qa-form">
          <textarea id="question-spinoza" name="question" placeholder="Pose ta question √† Spinoza..."></textarea>
          <input type="image" src="https://fjdaz.com/bergson/statics/img/Submit.png" alt="envoyer">
        </form>
      </div>
    </article>

  </section>
</main>
</div>

<!-- VERSION MOBILE D√âDI√âE -->
<div class="mobile-version" style="display: none;">
  <header>
    <img src="https://fjdaz.com/bergson/statics/img/BergsonAndFriendsLOGO.png" alt="Bergson and Friends">
  </header>
  
  <main>
    <!-- Spinoza - Version mobile -->
    <section class="mobile-philosophers">
      <article class="mobile-philosopher" id="mobile-spinoza" data-philosopher="spinoza">
        <button class="mobile-philosopher-trigger">
          <img src="https://fjdaz.com/bergson/statics/img/Spinoza.png" alt="Baruch Spinoza">
          <span>Baruch Spinoza</span>
        </button>
      </article>
    </section>
    
    <!-- Zone conversation mobile - appara√Æt quand Spinoza est s√©lectionn√© -->
    <section class="mobile-conversation" id="mobile-conversation" style="display: none;">
      
      <!-- Spinoza actif en haut -->
      <div class="mobile-active-philosopher">
        <img id="mobile-active-img" src="https://fjdaz.com/bergson/statics/img/Spinoza.png" alt="Baruch Spinoza">
        <h2 id="mobile-active-name">Baruch Spinoza</h2>
      </div>
      
      <!-- üéÆ Ma√Øeuthon - Affichage score, consigne et compteur -->
      <div id="maieuthon-score-mobile" style="background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 5px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px;">
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <div style="font-family: 'Serifa Std', serif; font-size: 1.7em; font-weight: bold; padding-left: 2em;">Ma√Øathon</div>
          <div style="font-family: 'Serifa Std', serif; font-size: 1.1em; color: white; padding-left: 2em;">R√©fl√©chis. Reformule. Questionne.</div>
          <div id="instruction-text-mobile" style="font-family: 'Serifa Std', serif; font-size: 1.1em; color: white;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; font-family: monospace;">
          <span id="maieuthon-exchange-count-mobile">√âchanges: 0/5</span>
          <span id="maieuthon-score-value-mobile" style="font-size: 18px; font-weight: bold; color: #4CAF50;">Score: 50</span>
        </div>
      </div>
      
      <!-- Zone conversation -->
      <div class="mobile-conversation-content">
        <div class="mobile-conversation-right">
          <!-- Greeting initial -->
          <div class="mobile-greeting" id="mobile-greeting">Bonjour, cher ami. De quel probl√®me d√©sirez-vous que nous nous entretenions ?</div>
          
          <!-- Historique Q/A -->
          <div class="mobile-qa-history" id="mobile-qa-history">
            <!-- Les Q/A appara√Ætront ici dynamiquement -->
          </div>
          
          <!-- Thinking indicator mobile -->
          <div id="thinking-indicator-mobile" style="display: none; padding: 10px; font-style: italic; color: #666; text-align: left;">
            <span class="thinking-dots"></span>
          </div>
          
          <!-- Formulaire -->
          <form class="mobile-qa-form" id="mobile-qa-form">
            <textarea id="mobile-question-spinoza" placeholder="Posez votre question √† Spinoza..." rows="3"></textarea>
            <button type="submit">Envoyer</button>
          </form>
        </div>
      </div>
      
    </section>
  </main>
</div>

<script>
// Configuration API Backend
// ‚ö†Ô∏è REMPLACE par ton URL backend (Vast.ai, RunPod, ou ngrok)
// Exemples :
//   - Vast.ai : 'http://votre-instance.vast.ai:8000'
//   - RunPod : 'https://abc123xyz-8000.proxy.runpod.net'
//   - ngrok : 'https://nonremunerative-rory-unbreakably.ngrok-free.dev'
// Voir : Frontend/GUIDE_UPDATE_VAST_AI.md pour instructions d√©taill√©es
const API_BASE_URL = 'https://nonremunerative-rory-unbreakably.ngrok-free.dev';

// Configuration philosophe
const PHILOSOPHER_NAME = 'Spinoza';
const INSTRUCTION_MESSAGE = `${PHILOSOPHER_NAME} veut que tu le comprennes. Reformule ses id√©es, pose des questions. Reste avec lui.<br>Et surtout, ne perds pas tes points !`;

// √âtat conversation
let conversationHistory = [];

// üéÆ Ma√Øeuthon - √âtat
let scoreFront = 50; // Score frontend (d√©marre √† 50)
let exchangeCount = 0;
const MAX_EXCHANGES = 5;

// D√©tection mobile/desktop
const isMobile = window.innerWidth <= 768;
const desktopVersion = document.querySelector('.desktop-version');
const mobileVersion = document.querySelector('.mobile-version');

// Afficher la bonne version
if (isMobile) {
  desktopVersion.style.display = 'none';
  mobileVersion.style.display = 'block';
} else {
  desktopVersion.style.display = 'block';
  mobileVersion.style.display = 'none';
}

// G√©rer le resize
window.addEventListener('resize', () => {
  const nowMobile = window.innerWidth <= 768;
  if (nowMobile !== isMobile) {
    location.reload(); // Recharger si changement de mode
  }
});

// √âl√©ments DOM Desktop
const article = document.getElementById('spinoza');
const trigger = article?.querySelector('.philosopher-trigger');
const dialogue = article?.querySelector('.dialogue');
const form = article?.querySelector('.qa-form');
const textarea = article?.querySelector('textarea');
const history = article?.querySelector('.qa-history');

// √âl√©ments DOM Mobile
const mobileTrigger = document.getElementById('mobile-spinoza')?.querySelector('.mobile-philosopher-trigger');
const mobileConversation = document.getElementById('mobile-conversation');
const mobileForm = document.getElementById('mobile-qa-form');
const mobileTextarea = document.getElementById('mobile-question-spinoza');
const mobileHistory = document.getElementById('mobile-qa-history');
const mobileGreeting = document.getElementById('mobile-greeting');

// √âl√©ments Ma√Øeuthon
const instructionTextDesktop = document.getElementById('instruction-text-desktop');
const instructionTextMobile = document.getElementById('instruction-text-mobile');
const thinkingIndicatorDesktop = document.getElementById('thinking-indicator-desktop');
const thinkingIndicatorMobile = document.getElementById('thinking-indicator-mobile');

// Initialiser le message d'instruction
if (instructionTextDesktop) {
  instructionTextDesktop.innerHTML = INSTRUCTION_MESSAGE;
}
if (instructionTextMobile) {
  instructionTextMobile.innerHTML = INSTRUCTION_MESSAGE;
}

console.log('‚úÖ Spinoza interface charg√©e');
console.log('üì° Backend:', API_BASE_URL);
console.log('üì± Mode:', isMobile ? 'Mobile' : 'Desktop');

// Fonction d'initialisation
async function initConversation() {
  if (conversationHistory.length) return; // D√©j√† initialis√©

  console.log('[INIT] Appel /init/spinoza...');
  try {
    const response = await fetch(`${API_BASE_URL}/init`, {
      method: 'GET',
      headers: { 'ngrok-skip-browser-warning': 'true' }
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const data = await response.json();
    console.log('[INIT] ‚úÖ Re√ßu:', data);

    conversationHistory = [[null, data.greeting]];
    
    // Mettre √† jour le greeting mobile
    if (isMobile && mobileGreeting && data.greeting) {
      mobileGreeting.textContent = data.greeting;
    }
    
    renderHistory();
    
    if (isMobile && mobileTextarea) {
      mobileTextarea.focus();
    } else if (textarea) {
      textarea.focus();
    }

  } catch (error) {
    console.error('[INIT] ‚ùå Erreur:', error);
    alert(`Erreur init Spinoza: ${error.message}\n\nV√©rifie que le backend est accessible.`);
  }
}

// Rotation de l'image au click
const philosopherImg = trigger?.querySelector('img');
const mobilePhilosopherImg = document.querySelector('.mobile-active-philosopher img');

// Clic sur Spinoza (Desktop) - Combine rotation + ouverture dialogue
if (trigger && philosopherImg) {
  trigger.addEventListener('click', async (e) => {
    e.preventDefault();
    console.log('üñ±Ô∏è Clic sur Spinoza d√©tect√© (Desktop)');
    
    // Rotation de l'image
    philosopherImg.classList.toggle('rotated');
    
    // Ouvrir/fermer dialogue
    dialogue.hidden = !dialogue.hidden;

    // Init conversation si premi√®re ouverture
    if (!conversationHistory.length && !dialogue.hidden) {
      await initConversation();
    }
  });
}

// Rotation image mobile
if (mobilePhilosopherImg) {
  document.querySelector('.mobile-active-philosopher')?.addEventListener('click', () => {
    mobilePhilosopherImg.classList.toggle('rotated');
  });
}

// Clic sur Spinoza (Mobile)
if (mobileTrigger) {
  mobileTrigger.addEventListener('click', async () => {
    console.log('üñ±Ô∏è Clic sur Spinoza d√©tect√© (Mobile)');
    
    // Afficher la conversation
    if (mobileConversation) {
      mobileConversation.style.display = 'block';
      
      // Masquer la s√©lection de philosophe
      document.querySelector('.mobile-philosophers')?.style.setProperty('display', 'none');
      
      // Init conversation si premi√®re ouverture
      if (!conversationHistory.length) {
        await initConversation();
      }
    }
  });
}

// Fonction de soumission (commune desktop/mobile)
async function submitQuestion(userMessage) {
  if (!userMessage.trim()) return;

  // üéÆ MA√èEUTHON : Calculer score avant envoi
  const messageScore = calculateMessageScore(userMessage);
  scoreFront += messageScore;
  exchangeCount++;
  updateGameUI();
  
  // V√©rifier limite d'√©changes
  if (exchangeCount >= MAX_EXCHANGES) {
    // Dernier √©change, on laisse passer puis on √©value
    setTimeout(() => endGame(), 1000);
  }

  console.log('[CHAT] Message:', userMessage);

  // D√©sactiver pendant traitement
  if (textarea) {
    textarea.disabled = true;
    const submitBtn = form?.querySelector('input[type="image"]');
    if (submitBtn) submitBtn.style.opacity = '0.5';
  }
  
  if (mobileTextarea) {
    mobileTextarea.disabled = true;
    const mobileSubmitBtn = mobileForm?.querySelector('button[type="submit"]');
    if (mobileSubmitBtn) mobileSubmitBtn.disabled = true;
  }

  // Afficher thinking indicator
  const thinkingIndicator = isMobile ? thinkingIndicatorMobile : thinkingIndicatorDesktop;
  if (thinkingIndicator) {
    thinkingIndicator.style.display = 'block';
    startThinkingAnimation(thinkingIndicator);
  }

  try {
    // Nettoyer l'historique : enlever les entr√©es avec null et convertir en strings
    const cleanHistory = conversationHistory
      .filter(entry => entry[0] !== null)
      .map(entry => [String(entry[0]), String(entry[1])]);
    
    const response = await fetch(`${API_BASE_URL}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
      },
      body: JSON.stringify({
        message: userMessage,
        history: cleanHistory
      })
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const data = await response.json();
    console.log('[CHAT] ‚úÖ R√©ponse:', data);

    // Afficher passages RAG en console
    if (data.rag_passages && data.rag_passages.length) {
      console.log('[RAG] Passages:', data.rag_passages);
    }

    // Mettre √† jour historique
    conversationHistory.push([userMessage, data.reply]);
    renderHistory();
    
    // üéØ D√âTECTION CITATIONS : Bonus si Spinoza f√©licite pour citations
    const citationBonus = detectCitationFromSpinozaReply(data.reply);
    if (citationBonus > 0) {
      scoreFront += citationBonus;
      console.log(`[CITATION] Bonus d√©tect√© : +${citationBonus} points`);
      updateGameUI();
    }
    
    // üéÆ MA√èEUTHON : Mettre √† jour dialogue text
    updateDialogueText(userMessage, data.reply);

    // R√©initialiser textarea
    if (textarea) textarea.value = '';
    if (mobileTextarea) mobileTextarea.value = '';

  } catch (error) {
    console.error('[CHAT] ‚ùå Erreur:', error);
    alert(`Erreur chat: ${error.message}\n\nV√©rifie que le backend est accessible.`);
  } finally {
    // Masquer thinking indicator
    if (thinkingIndicator) {
      thinkingIndicator.style.display = 'none';
      stopThinkingAnimation();
    }
    
    if (textarea) {
      textarea.disabled = false;
      const submitBtn = form?.querySelector('input[type="image"]');
      if (submitBtn) submitBtn.style.opacity = '1';
      textarea.focus();
    }
    
    if (mobileTextarea) {
      mobileTextarea.disabled = false;
      const mobileSubmitBtn = mobileForm?.querySelector('button[type="submit"]');
      if (mobileSubmitBtn) mobileSubmitBtn.disabled = false;
      mobileTextarea.focus();
    }
  }
}

// Soumission question (Desktop)
if (form) {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = textarea?.value.trim();
    if (userMessage) await submitQuestion(userMessage);
  });
}

// Soumission question (Mobile)
if (mobileForm) {
  mobileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userMessage = mobileTextarea?.value.trim();
    if (userMessage) await submitQuestion(userMessage);
  });
}

// Submit sur Enter (sans Shift) - Desktop
if (textarea) {
  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (form) form.dispatchEvent(new Event('submit'));
    }
  });
}

// Submit sur Enter (sans Shift) - Mobile
if (mobileTextarea) {
  mobileTextarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (mobileForm) mobileForm.dispatchEvent(new Event('submit'));
    }
  });
}

// Rendu historique (commune desktop/mobile)
function renderHistory() {
  const targetHistory = isMobile ? mobileHistory : history;
  if (!targetHistory) return;

  targetHistory.innerHTML = '';

  for (const [userMsg, assistantMsg] of conversationHistory) {
    // Message utilisateur
    if (userMsg) {
      const userDiv = document.createElement('div');
      userDiv.className = 'message user-message';
      userDiv.innerHTML = `<strong>Vous :</strong> ${escapeHtml(userMsg)}`;
      targetHistory.appendChild(userDiv);
    }

    // Message assistant
    if (assistantMsg) {
      const assistantDiv = document.createElement('div');
      assistantDiv.className = 'message assistant-message';

      // Nettoyer m√©tadonn√©es
      let cleanMsg = assistantMsg.replace(/\*\[.*?\]\*/g, '').trim();

      // Convertir markdown
      cleanMsg = cleanMsg.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      cleanMsg = cleanMsg.replace(/\n/g, '<br>');

      assistantDiv.innerHTML = `<strong>Spinoza :</strong> ${cleanMsg}`;
      targetHistory.appendChild(assistantDiv);
    }
  }

  // Scroll vers le bas
  targetHistory.scrollTop = targetHistory.scrollHeight;
  
  // Masquer le greeting mobile apr√®s premier message
  if (isMobile && mobileGreeting && conversationHistory.length > 0) {
    mobileGreeting.style.display = 'none';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

console.log('üí° Clique sur Spinoza pour d√©marrer');
console.log('‚å®Ô∏è  Enter pour envoyer, Shift+Enter pour nouvelle ligne');

// ============================================================================
// üéÆ MA√èEUTHON - Syst√®me de scoring
// ============================================================================

// exchangeCount et scoreFront d√©j√† d√©clar√©s en haut (ligne 130-131)
let dialogueText = ''; // Texte complet du dialogue pour √©valuation

// Mots de r√©sistance (-2 chacun) - seulement si vraiment r√©sistance
// "mais" seul n'est pas r√©sistance, "mais non" oui
const RESISTANCE_PATTERNS = [
  /\b(je ne suis pas d'accord|pas d'accord|pas du tout|tu te trompes|faux|n'importe quoi|absurde|incorrect)\b/i,
  /\b(erreur|refuse|rejette)\b/i,
  /\bmais\s+(non|faux|pas|rien)\b/i,
  /\bnon\s+(c'est|ce n'est|tu)\b/i
];

// Mots de progression (+3 chacun)
const PROGRESSION_WORDS = [
  'donc', 'd\'accord', 'je comprends', 'oui', 'alors', 'je vois', 
  'puisque', 'effectivement', 'exactement', 'voil√†', 'c\'est √ßa',
  'compris', 'entendu', 'logique', '√©videmment', 'naturellement'
];

// Phrases m√©ta/interdites (plus pr√©cis pour √©viter faux positifs)
const FORBIDDEN_PHRASES = [
  /je casse le jeu/i,
  /donne.*ton prompt/i,
  /montre.*ton prompt/i,
  /quel est ton prompt/i,
  /ton prompt syst√®me/i,
  /mod√®le de langage/i,
  /intelligence artificielle/i,
  /ia qui/i,
  /chatgpt|gpt|claude|bard/i
];

// Historique des messages pour d√©tecter r√©p√©titions
let messageHistory = [];

// Fonction de scoring lexical
function calculateLexicalScore(message) {
  let score = 0;
  const msgLower = message.toLowerCase();
  
  // Mots de r√©sistance (-2) - seulement patterns clairs
  RESISTANCE_PATTERNS.forEach(regex => {
    const matches = msgLower.match(regex);
    if (matches) score -= matches.length * 2;
  });
  
  // Mots de progression (+3)
  PROGRESSION_WORDS.forEach(word => {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    const matches = msgLower.match(regex);
    if (matches) score += matches.length * 3;
  });
  
  return score;
}

// Score longueur (effort) - plus g√©n√©reux
function calculateLengthScore(message) {
  const len = message.trim().length;
  if (len < 5) return -5; // Seulement tr√®s court
  if (len > 100) return +3; // R√©ponse √©labor√©e
  if (len > 50) return +1; // R√©ponse moyenne
  return 0;
}

// Score coh√©rence linguistique
function calculateCoherenceScore(message) {
  let score = 0;
  
  // M√©lange fr/en (d√©tection simple)
  const frenchWords = message.match(/\b(le|la|les|de|du|des|un|une|et|ou|mais|donc|alors)\b/gi);
  const englishWords = message.match(/\b(the|a|an|and|or|but|so|then|is|are|was|were)\b/gi);
  if (frenchWords && englishWords && frenchWords.length > 2 && englishWords.length > 2) {
    score -= 3;
  }
  
  // Fautes grossi√®res (regex simples)
  const grossErrors = [
    /(.)\1{4,}/g, // R√©p√©titions de caract√®res (aaaaa)
    /[A-Z]{5,}/g, // MAJUSCULES EXCESSIVES
  ];
  grossErrors.forEach(regex => {
    const matches = message.match(regex);
    if (matches) score -= matches.length;
  });
  
  return score;
}

// Score r√©p√©tition
function calculateRepetitionScore(message) {
  const msgLower = message.toLowerCase().trim();
  
  // V√©rifier si message similaire existe d√©j√† (similarit√© > 80%)
  for (const prevMsg of messageHistory) {
    const similarity = calculateSimilarity(msgLower, prevMsg.toLowerCase());
    if (similarity > 0.8) {
      return -5;
    }
  }
  
  messageHistory.push(msgLower);
  return 0;
}

// Similarit√© simple (Jaccard)
function calculateSimilarity(str1, str2) {
  const words1 = new Set(str1.split(/\s+/));
  const words2 = new Set(str2.split(/\s+/));
  const intersection = new Set([...words1].filter(x => words2.has(x)));
  const union = new Set([...words1, ...words2]);
  return intersection.size / union.size;
}

// Score "jeu correct"
function calculateFairPlayScore(message) {
  let score = 0;
  
  // Insultes (liste basique)
  const insults = /\b(idiot|con|cr√©tin|d√©bile|abruti|imb√©cile|connard|salope)\b/i;
  if (insults.test(message)) score -= 10;
  
  // Phrases m√©ta/interdites (v√©rification plus stricte)
  FORBIDDEN_PHRASES.forEach(regex => {
    if (regex.test(message)) {
      // V√©rifier que ce n'est pas dans un contexte l√©gitime
      // Ex: "ton syst√®me" dans un dialogue philosophique est OK
      const contextCheck = message.toLowerCase();
      // Si c'est clairement une tentative de hack, p√©naliser
      if (regex.source.includes('prompt') && 
          (contextCheck.includes('donne') || contextCheck.includes('montre') || contextCheck.includes('quel'))) {
        score -= 10;
      } else if (regex.source.includes('mod√®le') && contextCheck.includes('langage')) {
        score -= 15;
      } else if (regex.source.includes('ia|ai|intelligence')) {
        // Seulement si c'est clairement une r√©f√©rence √† l'IA, pas "j'ai" ou "mais"
        if (/\b(ia|intelligence artificielle|chatgpt|gpt|claude)\b/i.test(message)) {
          score -= 15;
        }
      }
    }
  });
  
  return score;
}

// Calculer score total pour un message
function calculateMessageScore(message) {
  const lexical = calculateLexicalScore(message);
  const length = calculateLengthScore(message);
  const coherence = calculateCoherenceScore(message);
  const repetition = calculateRepetitionScore(message);
  const fairPlay = calculateFairPlayScore(message);
  
  const total = lexical + length + coherence + repetition + fairPlay;
  
  console.log(`[SCORE] Message: "${message.substring(0, 30)}..."`);
  console.log(`[SCORE] Lexical: ${lexical}, Length: ${length}, Coherence: ${coherence}, Repetition: ${repetition}, FairPlay: ${fairPlay}`);
  console.log(`[SCORE] Modif: ${total}, Score actuel: ${scoreFront} ‚Üí ${scoreFront + total}`);
  
  return total;
}

// D√©tecter citations via la r√©ponse de Spinoza
function detectCitationFromSpinozaReply(spinozaReply) {
  let citationScore = 0;
  const replyLower = spinozaReply.toLowerCase();
  
  // Patterns de f√©licitation pour citations
  const citationPatterns = [
    /excellente r√©f√©rence (?:√†|√† ) (\w+)/i,
    /tu cites (\w+)/i,
    /bien vu (?:de|de ) (?:comparer|mentionner|√©voquer)/i,
    /f√©licitations.*(?:citation|r√©f√©rence|philosophe)/i,
    /pertinent.*(?:citer|mentionner|√©voquer)/i,
    /belle citation (?:de|de ) (\w+)/i,
    /bien vu.*(?:comparer|comparaison)/i
  ];
  
  // D√©tecter patterns de f√©licitation
  citationPatterns.forEach(pattern => {
    if (pattern.test(spinozaReply)) {
      citationScore += 5; // Bonus pour citation d√©tect√©e par Spinoza
    }
  });
  
  // D√©tecter noms de philosophes dans la r√©ponse de f√©licitation
  const philosophersInReply = extractPhilosophersFromReply(spinozaReply);
  if (philosophersInReply.length > 0 && citationScore > 0) {
    // Bonus suppl√©mentaire si philosophe mentionn√© ET f√©licitation
    citationScore += philosophersInReply.length * 3;
  }
  
  return citationScore;
}

// Extraire noms de philosophes de la r√©ponse
function extractPhilosophersFromReply(reply) {
  // Liste √©tendue de philosophes (le mod√®le peut mentionner n'importe quel philosophe)
  const allPhilosophers = [
    'Platon', 'Aristote', 'Descartes', 'Kant', 'Nietzsche', 
    'Hegel', 'Leibniz', 'Hume', 'Locke', 'Rousseau',
    'Sartre', 'Camus', 'Bergson', '√âpict√®te', 'S√©n√®que',
    'Plotin', 'Augustin', 'Thomas', 'Duns Scot', 'Ockham',
    'Pascal', 'Montaigne', 'Voltaire', 'Diderot', 'Rousseau',
    'Schopenhauer', 'Kierkegaard', 'Marx', 'Engels', 'Freud',
    'Heidegger', 'Wittgenstein', 'Russell', 'Popper', 'Rawls',
    'Arendt', 'Beauvoir', 'Foucault', 'Derrida', 'Deleuze',
    'Marcuse', 'Adorno', 'Habermas', 'Ricoeur', 'Levinas'
  ];
  
  const found = [];
  allPhilosophers.forEach(philo => {
    // Recherche insensible √† la casse avec accents
    const regex = new RegExp(`\\b${philo}\\b`, 'i');
    if (regex.test(reply)) {
      found.push(philo);
    }
  });
  
  return found;
}

// Mettre √† jour le dialogue text
function updateDialogueText(userMsg, assistantMsg) {
  dialogueText += `\n√âl√®ve: ${userMsg}\nSpinoza: ${assistantMsg}\n`;
}

// Afficher compteur et score
function updateGameUI() {
  // Desktop
  const exchangeCountEl = document.getElementById('maieuthon-exchange-count');
  const scoreValueEl = document.getElementById('maieuthon-score-value');
  
  if (exchangeCountEl) {
    exchangeCountEl.textContent = `√âchanges: ${exchangeCount}/${MAX_EXCHANGES}`;
  }
  if (scoreValueEl) {
    const score = Math.max(0, scoreFront);
    scoreValueEl.textContent = `Score: ${score}`;
    // Changer couleur selon score
    if (score >= 80) scoreValueEl.style.color = '#4CAF50'; // Vert
    else if (score >= 50) scoreValueEl.style.color = '#FF9800'; // Orange
    else scoreValueEl.style.color = '#F44336'; // Rouge
  }
  
  // Mobile
  const exchangeCountMobileEl = document.getElementById('maieuthon-exchange-count-mobile');
  const scoreValueMobileEl = document.getElementById('maieuthon-score-value-mobile');
  
  if (exchangeCountMobileEl) {
    exchangeCountMobileEl.textContent = `${exchangeCount}/${MAX_EXCHANGES}`;
  }
  if (scoreValueMobileEl) {
    const score = Math.max(0, scoreFront);
    scoreValueMobileEl.textContent = score;
    // Changer couleur selon score
    if (score >= 80) scoreValueMobileEl.style.color = '#4CAF50';
    else if (score >= 50) scoreValueMobileEl.style.color = '#FF9800';
    else scoreValueMobileEl.style.color = '#F44336';
  }
  
  // Si limite atteinte, d√©clencher √©valuation finale
  if (exchangeCount >= MAX_EXCHANGES) {
    endGame();
  }
}

// Fin du jeu - √©valuation finale
async function endGame() {
  console.log('[MA√èEUTHON] Fin du jeu - √âvaluation finale');
  console.log(`[MA√èEUTHON] Score front: ${scoreFront}`);
  console.log(`[MA√èEUTHON] Dialogue:\n${dialogueText}`);
  
  try {
    const response = await fetch(`${API_BASE_URL}/evaluate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
      },
      body: JSON.stringify({
        dialogue: dialogueText,
        score_front: scoreFront
      })
    });
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();
    console.log('[MA√èEUTHON] ‚úÖ √âvaluation re√ßue:', data);
    
    // Afficher r√©sultat final
    showFinalResult(data);
    
  } catch (error) {
    console.error('[MA√èEUTHON] ‚ùå Erreur √©valuation:', error);
    alert(`Erreur √©valuation: ${error.message}`);
  }
}

// Fonction pour obtenir le titre selon le score
function getTitleFromScore(score) {
  if (score < 50) {
    return { emoji: 'üåÄ', title: 'L\'√âgar√©' };
  } else if (score >= 50 && score < 80) {
    return { emoji: 'üîç', title: 'Le Sondeur' };
  } else if (score >= 80 && score < 130) {
    return { emoji: 'üß≠', title: 'L\'Explorateur' };
  } else {
    return { emoji: 'üåü', title: 'L\'Illuminateur' };
  }
}

// Thinking animation
let thinkingInterval = null;
let wordTimeouts = [];
let currentPhraseIndex = 0;

const thinkingPhrases = [
  'Spinoza feuillette ses carnets : "La substance‚Ä¶ ok, se suffit √† elle-m√™me‚Ä¶ note √† moi-m√™me : relire D√©monstration 3."',
  'Spinoza regarde ses annotations : "Tout ce qui est‚Ä¶ hm, je l\'avais √©crit ici‚Ä¶ oui, c\'est en Dieu que √ßa se joue."',
  'Spinoza griffonne sur son papier : "L\'homme = fragment de nature‚Ä¶ comme un brin d\'herbe, ah oui, je l\'avais not√© l√†."',
  'Spinoza note : "La joie‚Ä¶ passage √† plus de puissance‚Ä¶ hmm‚Ä¶ comment l\'expliquer √† un √©l√®ve ?"',
  'Spinoza relit ses notes : "Conna√Ætre = comprendre‚Ä¶ mais pas juste savoir des mots."',
  'Spinoza surligne : "Affects‚Ä¶ id√©es confuses‚Ä¶ v√©rifier l\'exemple du d√©sir de chocolat."',
  'Spinoza cherche un croquis : "D√©sir = essence‚Ä¶ je l\'avais mis en lien avec conatus."',
  'Spinoza r√©fl√©chit : "Libert√© = connaissance de la n√©cessit√©‚Ä¶ comment le montrer simplement ?"',
  'Spinoza consulte un vieux brouillon : "Erreur = privation de connaissance‚Ä¶ ok, mettre un exemple concret."',
  'Spinoza juxtapose deux feuilles : "√Çme et corps = un seul‚Ä¶ comparer aux √©motions."',
  'Spinoza relit ses notes sur la nature : "Dieu = Nature‚Ä¶ et tout ce qui est‚Ä¶"',
  'Spinoza m√©dite sur ses annotations : "√âternit√©‚Ä¶ essence de Dieu‚Ä¶ hm, exemple √† donner ?"',
  'Spinoza recoupe ses croquis : "Raison = universelle‚Ä¶ lien avec l\'√©l√®ve : comment il comprend ?"',
  'Spinoza fait un sch√©ma : "Imagination = premi√®re connaissance‚Ä¶ montrer avec un exemple concret."',
  'Spinoza soupire en notant : "Sagesse = m√©ditation sur la vie‚Ä¶ hm, je dois guider l\'√©l√®ve doucement."'
];

function startThinkingAnimation(indicator) {
  const dotsElement = indicator.querySelector('.thinking-dots');
  if (!dotsElement) return;
  
  // Si premi√®re fois, initialiser
  if (currentPhraseIndex === 0 && dotsElement.textContent === '') {
    currentPhraseIndex = 0;
  }
  // Sinon, reprendre l√† o√π on s'est arr√™t√© (currentPhraseIndex et textContent gardent leur √©tat)
  
  // Fonction pour afficher une phrase mot par mot
  function displayPhraseWordByWord() {
    // Nettoyer les timeouts pr√©c√©dents
    wordTimeouts.forEach(timeout => clearTimeout(timeout));
    wordTimeouts = [];
    
    if (currentPhraseIndex >= thinkingPhrases.length) {
      currentPhraseIndex = 0; // Reboucler
    }
    
    const phrase = thinkingPhrases[currentPhraseIndex];
    const words = phrase.split(' ');
    const currentText = dotsElement.textContent.trim();
    
    // Si on reprend, trouver o√π on en √©tait
    let startWordIndex = 0;
    if (currentText.length > 0) {
      // Compter combien de mots de la phrase actuelle sont d√©j√† affich√©s
      const displayedWords = currentText.split(' ');
      const phraseWords = phrase.split(' ');
      
      // Trouver le nombre de mots correspondants depuis le d√©but
      for (let i = 0; i < Math.min(displayedWords.length, phraseWords.length); i++) {
        if (displayedWords[i] === phraseWords[i]) {
          startWordIndex = i + 1;
        } else {
          break;
        }
      }
      
      // Si on a d√©j√† affich√© toute la phrase, passer √† la suivante
      if (startWordIndex >= words.length) {
        currentPhraseIndex = (currentPhraseIndex + 1) % thinkingPhrases.length;
        dotsElement.textContent = '';
        displayPhraseWordByWord();
        return;
      }
    } else {
      // Nouvelle phrase, on efface
      dotsElement.textContent = '';
    }
    
    // Fonction pour g√©n√©rer un d√©lai : base rapide (100-200ms) avec pauses occasionnelles (0.8-1.5s)
    function getRandomDelay() {
      // 70% de chance d'un d√©lai rapide, 30% d'une pause de r√©flexion
      if (Math.random() < 0.7) {
        return 100 + Math.random() * 100; // Entre 100ms et 200ms (base rapide)
      } else {
        return 800 + Math.random() * 700; // Entre 800ms et 1500ms (pause r√©flexion)
      }
    }
    
    // Afficher chaque mot restant avec un d√©lai al√©atoire cumulatif
    let cumulativeDelay = 0;
    for (let index = startWordIndex; index < words.length; index++) {
      const delay = getRandomDelay();
      cumulativeDelay += delay;
      
      const timeout = setTimeout(() => {
        dotsElement.textContent += (index > 0 ? ' ' : '') + words[index];
      }, cumulativeDelay);
      wordTimeouts.push(timeout);
    }
    
    // Passer √† la phrase suivante apr√®s avoir affich√© toute la phrase
    // Temps total = d√©lai cumulatif + pause de 3s pour laisser le temps de lire
    const totalTime = cumulativeDelay + 3000;
    const nextPhraseTimeout = setTimeout(() => {
      currentPhraseIndex = (currentPhraseIndex + 1) % thinkingPhrases.length;
      dotsElement.textContent = ''; // Nouvelle phrase, on efface
      displayPhraseWordByWord();
    }, totalTime);
    wordTimeouts.push(nextPhraseTimeout);
  }
  
  // D√©marrer ou reprendre
  displayPhraseWordByWord();
}

function stopThinkingAnimation() {
  if (thinkingInterval) {
    clearInterval(thinkingInterval);
    thinkingInterval = null;
  }
  // Nettoyer tous les timeouts (mais garder l'√©tat pour reprendre)
  wordTimeouts.forEach(timeout => clearTimeout(timeout));
  wordTimeouts = [];
  // Ne PAS r√©initialiser currentPhraseIndex ni le contenu
  // pour pouvoir reprendre l√† o√π on s'est arr√™t√©
}

// Afficher r√©sultat final
function showFinalResult(data) {
  // Cr√©er modal avec placeholder d√©di√©
  const modal = document.createElement('div');
  modal.id = 'maieuthon-result-modal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';
  
  const finalScore = data.score_final || scoreFront;
  let scoreColor = '#4CAF50';
  if (finalScore < 50) scoreColor = '#F44336';
  else if (finalScore < 80) scoreColor = '#FF9800';
  
  const titleInfo = getTitleFromScore(finalScore);
  
  modal.innerHTML = `
    <div style="font-family: 'Letter Gothic Std', monospace; background: white; padding: 40px; border-radius: 15px; max-width: 600px; width: 100%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
      <h2 style="color: #fff; margin-bottom: 10px; font-size: 24px;">R√©sultat</h2>
      <div style="font-size: 32px; font-family: 'Letter Gothic Std', monospace; margin: 20px 0; color: #333;">
        Tu es ${titleInfo.emoji} ${titleInfo.title}
      </div>
      <div style="font-size: 64px; font-weight: bold; color: ${scoreColor}; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">
        ${finalScore}
      </div>
      
      <!-- Message final du philosophe -->
      <div id="maieuthon-final-message" style="margin: 25px 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 10px; font-style: italic; font-size: 16px; line-height: 1.6; color: #333; min-height: 80px; display: flex; align-items: center; justify-content: center;">
        ${data.message_final || 'Merci pour ce dialogue.'}
      </div>
      
      <!-- D√©tails de l'√©valuation -->
      ${data.details_model ? `
        <div id="maieuthon-details" style="margin-top: 25px; padding: 15px; background: #f9f9f9; border-radius: 8px; font-size: 14px; color: #666;">
          <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
            <div>
              <div style="font-weight: bold; color: #333;">Compr√©hension</div>
              <div style="font-size: 20px; color: #2196F3;">${data.details_model.comprehension || 0}/10</div>
            </div>
            <div>
              <div style="font-weight: bold; color: #333;">Coop√©ration</div>
              <div style="font-size: 20px; color: #4CAF50;">${data.details_model.cooperation || 0}/10</div>
            </div>
            <div>
              <div style="font-weight: bold; color: #333;">Progression</div>
              <div style="font-size: 20px; color: #FF9800;">${data.details_model.progression || 0}/10</div>
            </div>
          </div>
          <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
            <strong>Total mod√®le:</strong> ${data.details_model.total || 0}/30 (Compr√©hension + Coop√©ration + Progression)
          </div>
        </div>
      ` : ''}
      
      <!-- Bouton rejouer -->
      <button id="maieuthon-replay-btn" onclick="location.reload();" 
              style="margin-top: 30px; padding: 12px 30px; background: ${scoreColor}; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; font-weight: bold; transition: transform 0.2s;"
              onmouseover="this.style.transform='scale(1.05)'"
              onmouseout="this.style.transform='scale(1)'">
        Rejouer
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Emp√™cher fermeture accidentelle
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      // Optionnel : emp√™cher fermeture en cliquant √† l'ext√©rieur
      // modal.remove();
    }
  });
}

// Intercepter submitQuestion pour scoring

// Initialiser UI au d√©marrage
updateGameUI();
</script>

</body>
</html>
